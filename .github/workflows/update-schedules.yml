name: Update Pool Schedules

on:
  schedule:
    # run every Friday at 8pm UTC (noon PST, to catch end-of-week changes before the weekend)
    - cron: "0 20 * * 5"
  workflow_dispatch:
    # allow manual trigger from GitHub Actions UI

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run schedule pipeline
        run: npm run build-schedules
        env:
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}

      - name: Check for changes
        id: diff
        run: |
          git diff --quiet public/data/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/
          git commit -m "Update pool schedules $(date -I)"
          git push

      - name: Get changelog summary
        id: changelog
        run: |
          # find the most recent changelog file
          CHANGELOG=$(ls -t data/changelog/*.json 2>/dev/null | head -1)
          if [ -n "$CHANGELOG" ]; then
            POOLS=$(jq -r '.poolsChanged' "$CHANGELOG")
            ADDED=$(jq -r '.totalProgramsAdded' "$CHANGELOG")
            REMOVED=$(jq -r '.totalProgramsRemoved' "$CHANGELOG")
            MODIFIED=$(jq -r '.totalProgramsModified' "$CHANGELOG")
            echo "summary=Pools: $POOLS changed, Programs: +$ADDED -$REMOVED ~$MODIFIED" >> $GITHUB_OUTPUT
          else
            echo "summary=Schedule update completed" >> $GITHUB_OUTPUT
          fi

      - name: Notify on changes
        if: steps.diff.outputs.changed == 'true'
        run: npx tsx scripts/notify.ts update "${{ steps.changelog.outputs.summary }}"
        env:
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          PUSHOVER_API_TOKEN: ${{ secrets.PUSHOVER_API_TOKEN }}

      - name: Notify no changes
        if: steps.diff.outputs.changed != 'true'
        run: npx tsx scripts/notify.ts no-changes
        env:
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          PUSHOVER_API_TOKEN: ${{ secrets.PUSHOVER_API_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ steps.diff.outputs.changed }}" == "true" ]; then
            echo "✅ Schedule data updated and committed"
          else
            echo "ℹ️ No changes detected in schedule data"
          fi

  notify-failure:
    runs-on: ubuntu-latest
    needs: update
    if: failure()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Notify on failure
        run: npx tsx scripts/notify.ts error "Schedule update workflow failed. Check GitHub Actions for details."
        env:
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          PUSHOVER_API_TOKEN: ${{ secrets.PUSHOVER_API_TOKEN }}
